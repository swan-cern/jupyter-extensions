{% extends "page.html" %}

{% block stylesheet %}
{{super()}}
<style type="text/css">
/* disable initial hide */
div#header, div#site {
    display: block;
}
#output-box {
    display: block;
    width: 1150px;
    height: 300px;
    overflow-y: scroll;
    overflow-x: hidden;
    white-space: pre-wrap;
    text-align: left;
    border: 1px solid #ccc;
    background-color: #f7f7f7;
    padding: 10px;
    border-radius: 5px;
}
#back_button {
    display: none;
    text-align: center;
    background-color: #fc6404;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
#next_button {
    display: none;
    text-align: center;
    background-color: #0454a4;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
</style>
{% endblock %}

{% block params %}
{{super()}}
data-base-url="{{base_url | urlencode}}"
{% endblock %}

{% block site %}

<div class="container">
    <div class="row">
        <div class="swan-info">
            <div id="swan-loader">
                <div class="loader-circle">
                    <img src="{{hub_prefix}}static/swan/logos/{{swan_logo_filename}}">
                </div>
                <div class="loader-line-mask">
                    <div class="loader-line"></div>
                </div>
                <span class="text">Creating environment...</span>
            </div>
        </div>
        <br><br>
        <div id="output-box"></div>
        <br>
        <button id="back_button">Back</button>
        <button id="next_button">Next</button>
    </div>
</div>

{% endblock %}

{% block script %}
    {{super()}}

<script type = "text/javascript" >
    
    var base_url = document.body.getAttribute('data-base-url');
    
    const urlParams = new URLSearchParams(window.location.search);
    var env_name = urlParams.get('env') || "";
    var repository = urlParams.get('repo') || "";
    var accpy_version = urlParams.get('accpy') || "";
    
    var project_folder = '/';
    if (repository.startsWith('http')) {
        // Extract repository name from URL
        const pattern = /^https?:\/\/[^/]+\/([^/\s]+)\/([^/\s]+)/;
        const match = repository.match(pattern);
        project_folder = match ? `/tree/SWAN_projects/${match[2]}` : '';
    } else {
        // Extract CERNBox path for EOS path repository, e.g /eos/user/u/username/project/local -> /tree/project/local
        const pattern = /^\/eos\/user\/([^/]+)\/([^/]+)(\/.*)?$/;
        const match = repository.match(pattern);
        project_folder = match && match[3] ? `/tree/${match[3]}` : '/'
    }

    var outputBox = document.getElementById('output-box');
    var loader = document.getElementById('swan-loader');
    var back_button = document.getElementById('back_button');
    var next_button = document.getElementById('next_button');
    var has_failed = false;
    var eventSource = new EventSource(`${base_url}api/customenvs?env=${encodeURIComponent(env_name)}&repo=${encodeURIComponent(repository)}&accpy=${encodeURIComponent(accpy_version)}`);
    
    eventSource.onmessage = (event) => {
        if (event.data === 'EOF') {
            // Close SSE connection and update UI when done
            eventSource.close();
            loader.getElementsByClassName('loader-line-mask')[0].style.display = 'none';
            if (has_failed) {
                loader.getElementsByClassName('text')[0].innerHTML = 'Error creating environment';
                back_button.onclick = () => window.location = `/hub/home?changeconfig`;
                back_button.style.display = 'block';
            } else {
                outputBox.innerHTML += `Environment ${env_name} created successfully.<br>`;
                outputBox.scrollTop = outputBox.scrollHeight;
                loader.getElementsByClassName('text')[0].innerHTML = 'Environment created';
                next_button.onclick = () => window.location = `${base_url}lab${project_folder}` ;
                next_button.style.display = 'block';
            }
        } else {
            // Update project folder if script changes it (don't show in output box)
            if (event.data.includes('FOLDER_NAME_CHANGE')) {
                const new_folder = event.data.split(':')[1];
                const folders = project_folder.split('/');
                folders[folders.length - 1] = new_folder;
                project_folder = folders.join('/');
                
            } else {
                // Add output to output-box
                outputBox.innerHTML += event.data + '<br>';
                outputBox.scrollTop = outputBox.scrollHeight;
                if (event.data.includes('ERROR')) {
                    has_failed = true;
                }
            }
        }
    };

    eventSource.onerror = (err) => {
        loader.getElementsByClassName('loader-line-mask')[0].style.display = 'none';
        loader.getElementsByClassName('text')[0].innerHTML = 'Error creating environment';
    };
    

</script>
{% endblock %}
